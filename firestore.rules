rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if incoming data has userId matching auth
    function hasValidUserId() {
      return isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // Helper to allow reads even if the doc does not yet exist
    function canReadResource() {
      return isAuthenticated() && (resource == null || resource.data.userId == request.auth.uid);
    }

    // Fallback for legacy docs that use an id prefix of `${uid}_...`
    function idHasUidPrefix(docId) {
      return isAuthenticated() && docId.matches('^' + request.auth.uid + '_.*$');
    }
    
    // Users collection - users can only read/write their own profile
    match /users/{userId} {
      allow read: if isOwner(userId) || (resource == null && request.auth.uid == userId);
      allow write: if isOwner(userId);
    }
    
    // Cycles collection - users can only access their own cycle data
    match /cycles/{cycleId} {
      allow read: if canReadResource();
      allow create: if hasValidUserId();
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Symptoms collection - users can only access their own symptom logs
    match /symptoms/{symptomId} {
      allow read: if canReadResource();
      allow create: if hasValidUserId();
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Meals collection - users can only access their own meal logs
    match /meals/{mealId} {
      allow read: if canReadResource();
      allow create: if hasValidUserId();
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Water intake collection - users can only access their own water logs
    match /waterIntake/{waterIntakeId} {
      allow read: if canReadResource();
      allow create: if hasValidUserId();
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Exercises collection - users can only access their own exercise logs
    match /exercises/{exerciseId} {
      allow read: if canReadResource();
      allow create: if hasValidUserId();
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Daily activities collection - users can only access their own daily activities
    match /dailyActivities/{activityId} {
      allow read: if canReadResource() || idHasUidPrefix(activityId);
      allow create: if hasValidUserId();
      allow update, delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || idHasUidPrefix(activityId));
    }
    
    // Streaks collection - users can only access their own streaks
    match /streaks/{streakId} {
      allow read: if canReadResource() || idHasUidPrefix(streakId);
      allow create: if hasValidUserId();
      allow update, delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || idHasUidPrefix(streakId));
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
